{% extends "base.html" %}
{% block title %}TOBE - Chi tiết sản phẩm{% endblock %}
{% block content %}
<script>
  const product_id = "{{ product_id }}";
  console.log('Product ID:', product_id);  // Kiểm tra giá trị
</script>
<div class="container py-5">
  <div class="row">
    <!-- Phần ảnh sản phẩm -->
    <div class="col-md-6 mb-4">
      <div class="product-gallery">
        <div class="main-image mb-3">
          <img src="{{ product.image_files[0] if product.image_files else url_for('static', filename='img/default-product.jpg') }}" 
               class="img-fluid" 
               alt="{{ product.name }}"
               id="mainImage">
        </div>
        <div class="thumbnail-images d-flex gap-2">
          {% for image in product.image_files %}
          <img src="{{ image }}" 
               class="thumbnail border p-1" 
               alt="{{ product.name }}"
               onclick="changeMainImage(this.src)"
               style="width: 60px; height: 60px; cursor: pointer;">
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Phần thông tin sản phẩm -->
    <div class="col-md-6">
      <h1 class="product-title mb-3">{{ product.name }}</h1>

      <!-- Giá sản phẩm -->
      <div class="price mb-3">
        {% if product.discounted_price %}
        <div>
          <span class="text-muted text-decoration-line-through">{{ product.original_price | number_format }}₫</span>
          <span class="text-danger fw-bold ms-2" style="font-size: 1.5rem;">{{ product.discounted_price | number_format }}₫</span>
        </div>
        {% else %}
        <div class="text-danger fw-bold" style="font-size: 1.5rem;">{{ product.original_price | number_format }}₫</div>
        {% endif %}
      </div>

      <!-- Lựa chọn biến thể -->
      <div class="variants mb-3">
        <h5>Chọn biến thể:</h5>
        <div class="d-flex flex-wrap gap-2">
          {% for variant in variants %}
          <label class="variant-item border p-2 rounded" style="cursor: pointer;">
            <input type="radio" 
                   name="variant" 
                   value="{{ variant.id }}" 
                   class="d-none"
                   data-variant-price="{{ variant.value }}"
                   data-variant-image="{{ variant.image_file if variant.image_file else '' }}">
            <img src="{{ variant.image_file if variant.image_file else url_for('static', filename='img/default-variant.jpg') }}" 
                 alt="{{ variant.name }}" 
                 class="img-thumbnail mb-1" style="width: 60px; height: 60px;">
            <div class="text-center">{{ variant.name }}</div>
          </label>
          {% endfor %}
        </div>
        <div id="variantError" class="text-danger mt-2" style="display: none;">Vui lòng chọn một biến thể.</div>
      </div>

      <!-- Số lượng -->
      <div class="quantity mb-3">
        <h5>Số lượng:</h5>
        <input type="number" name="quantity" id="quantity" value="1" min="1" class="form-control w-50 w-md-25">
      </div>

      <!-- Nút thêm vào giỏ hàng và mua ngay -->
      <div class="actions mb-3">
        <button type="button" class="btn btn-primary me-2" id="addToCartButton" disabled>Thêm vào giỏ hàng</button>
        <button type="button" class="btn btn-danger" id="buyNowButton">Mua ngay</button>
      </div>

      <!-- Tổng giá -->
      <div class="total-price mt-3">
        <h5>Tổng giá: <span id="totalPrice" class="text-danger">{{ product.discounted_price if product.discounted_price else product.original_price | number_format }}₫</span></h5>
      </div>
    </div>
  </div>

  <!-- Mô tả sản phẩm -->
  <div class="product-description mt-5">
    <h4>Mô tả sản phẩm</h4>
    <div class="border p-3 rounded">{{ product.description | safe }}</div>
  </div>

  <!-- Sản phẩm liên quan -->
  {% if related_products %}
  <div class="related-products mt-5">
    <h4>Sản phẩm liên quan</h4>
    <div class="row">
      {% for related in related_products %}
      <div class="col-md-3 col-sm-6 mb-4">
        <div class="card h-100">
          <img src="{{ related.image_files[0] if related.image_files else url_for('static', filename='img/default-product.jpg') }}" 
               class="card-img-top" 
               alt="{{ related.name }}">
          <div class="card-body">
            <h5 class="card-title">{{ related.name }}</h5>
            <p class="card-text">{{ related.discounted_price if related.discounted_price else related.original_price | number_format }}₫</p>
            <a href="{{ url_for('product', product_id=related.id) }}" class="btn btn-outline-primary">Xem chi tiết</a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>

<style>
  .product-gallery .main-image img {
    width: 100%;
    height: auto;
  }

  .product-gallery .thumbnail-images img {
    width: 60px;
    height: 60px;
    cursor: pointer;
  }

  .product-title {
    font-size: 2rem;
    font-weight: bold;
  }

  .price {
    font-size: 1.5rem;
  }

  .variants .variant-item {
    cursor: pointer;
  }

  .quantity input {
    max-width: 100px;
  }

  .actions button {
    width: 100%;
    margin-bottom: 10px;
  }

  .total-price {
    font-size: 1.25rem;
  }

  .product-description {
    font-size: 1rem;
  }

  .related-products .card {
    height: 100%;
  }

  .related-products .card-img-top {
    width: 100%;
    height: 200px;
    object-fit: cover;
  }

  .related-products .card-title {
    font-size: 1rem;
    font-weight: bold;
  }

  .related-products .card-text {
    font-size: 0.875rem;
    color: #666;
  }

  .related-products .btn {
    font-size: 0.875rem;
  }

  @media (max-width: 768px) {
    .product-gallery .thumbnail-images {
      justify-content: center;
    }

    .product-title {
      font-size: 1.5rem;
      text-align: center;
    }

    .price {
      text-align: center;
    }

    .variants {
      text-align: center;
    }

    .quantity {
      text-align: center;
    }

    .actions {
      text-align: center;
    }

    .total-price {
      text-align: center;
    }

    .product-description {
      text-align: center;
    }
  }
</style>

<script>
// Đổi ảnh chính khi nhấp vào thumbnail
function changeMainImage(src) {
  const mainImage = document.getElementById('mainImage');
  if (mainImage) {
    mainImage.src = src;
  }
}

// Cập nhật tổng giá
function updateTotalPrice() {
  const quantity = parseInt(document.getElementById('quantity').value);
  const selectedVariant = document.querySelector('.variants input[type="radio"]:checked');
  const price = selectedVariant ? parseFloat(selectedVariant.dataset.variantPrice) : 0;
  const totalPriceElement = document.getElementById('totalPrice');
  if (totalPriceElement) {
    totalPriceElement.textContent = new Intl.NumberFormat('vi-VN').format(quantity * price) + '₫';
  }
}

// Xử lý sự kiện chọn biến thể
const variantRadios = document.querySelectorAll('.variants input[type="radio"]');
variantRadios.forEach(radio => {
  radio.addEventListener('change', () => {
    const selectedVariant = document.querySelector('.variants input[type="radio"]:checked');
    if (selectedVariant) {
      const price = selectedVariant.dataset.variantPrice;
      document.getElementById('totalPrice').textContent = new Intl.NumberFormat('vi-VN').format(price) + '₫';

      const imageSrc = selectedVariant.dataset.variantImage;
      if (imageSrc) {
        document.getElementById('mainImage').src = imageSrc;
      }

      document.getElementById('variantError').style.display = 'none';
      document.getElementById('addToCartButton').disabled = false;
    }
  });
});

// Cập nhật tổng giá khi thay đổi số lượng
const quantityInput = document.getElementById('quantity');
if (quantityInput) {
  quantityInput.addEventListener('change', updateTotalPrice);
}

// Xử lý sự kiện thêm vào giỏ hàng
document.getElementById('addToCartButton').addEventListener('click', function () {
  const variant = document.querySelector('input[name="variant"]:checked');
  const quantity = parseInt(document.getElementById('quantity').value);

  if (!variant) {
    document.getElementById('variantError').style.display = 'block';
    return;
  }

  fetch(`/add_to_cart/${product_id}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      variant: variant.value,
      quantity: quantity,
    }),
  })
    .then((response) => response.json())
    .then((data) => {
      if (data.success) {
        alert(data.message);
        // Có thể cập nhật số lượng giỏ hàng
      } else {
        alert(data.message);
      }
    })
    .catch((error) => {
      console.error('Error:', error);
      alert('Có lỗi xảy ra!');
    });
});

// Xử lý sự kiện mua ngay
document.getElementById('buyNowButton').addEventListener('click', function () {
  const variant = document.querySelector('input[name="variant"]:checked');
  const quantity = parseInt(document.getElementById('quantity').value);

  if (!variant) {
    document.getElementById('variantError').style.display = 'block';
    return;
  }

  fetch(`/buy_now/${product_id}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      variant: variant.value,
      quantity: quantity,
    }),
  })
    .then((response) => response.json())
    .then((data) => {
      if (data.success) {
        window.location.href = data.redirect_url;
      } else {
        alert(data.message);
      }
    })
    .catch((error) => {
      console.error('Error:', error);
      alert('Có lỗi xảy ra!');
    });
});

</script>
{% endblock %}
